name: CI/CD Pipeline

on:
    push:
        branches:
            - main

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v3

            - name: Set Up Python
              uses: actions/setup-python@v4
              with:
                python-version: '3.9'
            
            - name: Login to Docker Hub
              uses: docker/login-action@v2
              with:
                username: $ {{ secrets.DOCKERHUB_USRENAME }}
                password: $ {{ secrets.DOCKERHUB_PASSWORD }}
            - name: Build Docker Image
              run: |
               docker build -t $ {{secrets.DOCKERHUB_USERNAME }}/flask-k8s-app:${{ github.run_id}} .
            - name: Push Docker image
              run: |
               docker push ${{ secrets.DOCKERHUB_USERNAME }}/flask-k8s-app:${{ github.run_id}}

            - name: Checkout code
              uses: actions/checkout@v4
              with:
                token: ${{ secrets.TOKEN}}

            - name: Update tag in Kubernetes Deployment Manifest
              run: |
               sed -i "s|image: .*|image: ${{ secrets.DOCKERHUB_USERNAME}}/flask-k8s-app:${{ github.run_id}}|" k8s/deployment.yaml
               
            - name: Commit and Push changes
              run: |
               git config --global user.name "Prameshwar-Thapa"
               git config --global user.email "thapaprameshwar7@gmail.com"
               git add k8s/deployment.yaml
               git commit -m "Web app image updated"
               git push origin HEAD:main -f